---
# Deploy Jellyfin media server to Kubernetes cluster
# This playbook deploys Jellyfin using Kustomize overlays
#
# Usage:
#   ansible-playbook playbooks/deploy-jellyfin.yml -e deploy_environment=production
#   ansible-playbook playbooks/deploy-jellyfin.yml -e deploy_environment=staging
#
# Prerequisites:
#   - Kubernetes cluster is running
#   - kubectl is configured on the control plane node
#   - Storage paths exist on the target storage node

- name: "Deploy Jellyfin Media Server"
  hosts: kube-master
  become: true
  gather_facts: true
  
  vars:
    # Default to production environment
    deploy_environment: production
    kustomize_overlay_path: "{{ playbook_dir }}/../../kustomize/apps/jellyfin/overlays/{{ deploy_environment }}"
    manifests_jellyfin_path: "{{ playbook_dir }}/../../manifests/jellyfin"
    
    # Deployment wait settings
    deployment_wait_timeout: 600
    deployment_check_interval: 30
    
  tasks:
    - name: "Validate environment selection"
      ansible.builtin.assert:
        that:
          - deploy_environment in ['production', 'staging']
        fail_msg: "Invalid deploy_environment '{{ deploy_environment }}'. Must be 'production' or 'staging'."
        success_msg: "Deploying to {{ deploy_environment }} environment"

    - name: "Check if kustomize is installed"
      ansible.builtin.command: which kustomize
      register: kustomize_check
      changed_when: false
      failed_when: false

    - name: "Use kubectl kustomize if kustomize not found"
      ansible.builtin.set_fact:
        kustomize_cmd: "{{ 'kustomize' if kustomize_check.rc == 0 else 'kubectl kustomize' }}"

    - name: "Verify kustomization overlay exists"
      ansible.builtin.stat:
        path: "{{ kustomize_overlay_path }}/kustomization.yaml"
      register: kustomize_overlay
      failed_when: not kustomize_overlay.stat.exists

    - name: "Prepare storage directories on storage node"
      delegate_to: storagenodet3500
      block:
        - name: "Create Jellyfin config directory"
          ansible.builtin.file:
            path: /var/lib/jellyfin
            state: directory
            owner: "1000"
            group: "1000"
            mode: '0755'

        - name: "Verify Jellyfin media directory exists"
          ansible.builtin.stat:
            path: /mnt/media
          register: jellyfin_media_dir

        - name: "Fail if /mnt/media is missing on storagenodet3500"
          ansible.builtin.fail:
            msg: "/mnt/media does not exist on storagenodet3500; create/mount it before deploying Jellyfin."
          when: not jellyfin_media_dir.stat.exists
      when: deploy_environment == 'production'

    - name: "Build and apply Kustomize overlay"
      ansible.builtin.shell: |
        {{ kustomize_cmd }} {{ kustomize_overlay_path }} | kubectl apply -f -
      register: kustomize_apply
      changed_when: "'configured' in kustomize_apply.stdout or 'created' in kustomize_apply.stdout"

    - name: "Display deployment output"
      ansible.builtin.debug:
        var: kustomize_apply.stdout_lines

    - name: "Wait for Jellyfin deployment rollout"
      ansible.builtin.command: "kubectl -n jellyfin rollout status deploy/jellyfin --timeout={{ deployment_wait_timeout }}s"
      register: jellyfin_rollout
      changed_when: false
      failed_when: false

    - name: "Get Jellyfin pod status"
      ansible.builtin.command: kubectl -n jellyfin get pods -l app=jellyfin -o wide
      register: jellyfin_pods
      changed_when: false
      failed_when: false

    - name: "Display Jellyfin pod status"
      ansible.builtin.debug:
        msg: |
          Jellyfin Deployment Status:
          {{ (jellyfin_pods.stdout_lines | default(['(no output)'])) | join('\n          ') }}

    - name: "Get Jellyfin service details"
      ansible.builtin.command: kubectl -n jellyfin get service jellyfin-service -o json
      register: jellyfin_svc_json
      changed_when: false
      failed_when: false

    - name: "Display access information"
      ansible.builtin.debug:
        msg: |
          Jellyfin Deployment Complete!
          
          Environment: {{ deploy_environment }}
          
          Access URLs:
            - kubectl: kubectl -n jellyfin get svc jellyfin-service -o wide
          
          Note: First startup may take several minutes for library scanning.
          when: jellyfin_rollout is not failed

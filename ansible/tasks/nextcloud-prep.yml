---
# Nextcloud preparation tasks (included by deploy-applications.yml)

- name: "Ensure nextcloud namespace exists"
  ansible.builtin.shell: |
    set -euo pipefail
    if kubectl get namespace nextcloud >/dev/null 2>&1; then
      exit 0
    fi
    kubectl create namespace nextcloud
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: nextcloud_ns_create
  changed_when: "'created' in (nextcloud_ns_create.stdout | lower)"

- name: "Ensure jq is installed on control-plane (required for Keycloak client creation script)"
  ansible.builtin.package:
    name: jq
    state: present

- name: "Prepare Nextcloud storage directories on homelab"
  delegate_to: homelab
  become: true
  block:
    - name: "Create Nextcloud data directories"
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: /srv/nextcloud/nextcloud, owner: '33', group: '33', mode: '0750' }
        - { path: /srv/nextcloud/mariadb, owner: '999', group: '999', mode: '0750' }

- name: "Fetch Keycloak admin credentials from cluster secret"
  ansible.builtin.shell: |
    set -euo pipefail
    # Primary: chart-managed Keycloak secret (identity stack source-of-truth)
    if kubectl -n identity get secret keycloak-admin >/dev/null 2>&1; then
      user=$(kubectl -n identity get secret keycloak-admin -o jsonpath='{.data.KEYCLOAK_USER}' | base64 -d)
      pass=$(kubectl -n identity get secret keycloak-admin -o jsonpath='{.data.KEYCLOAK_PASSWORD}' | base64 -d)
      printf '%s\n' "$user" "$pass"
      exit 0
    fi

    # Fallback: legacy credentials secret (some older flows)
    if kubectl -n identity get secret keycloak-admin-creds >/dev/null 2>&1; then
      user=$(kubectl -n identity get secret keycloak-admin-creds -o jsonpath='{.data.username}' | base64 -d)
      pass=$(kubectl -n identity get secret keycloak-admin-creds -o jsonpath='{.data.password}' | base64 -d)
      printf '%s\n' "$user" "$pass"
      exit 0
    fi

    echo "ERROR: Could not find Keycloak admin credentials secret (tried keycloak-admin and keycloak-admin-creds)" >&2
    exit 1
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: keycloak_admin_creds
  changed_when: false
  no_log: true

- name: "Set Keycloak and Nextcloud variables"
  ansible.builtin.set_fact:
    keycloak_admin_user: "{{ keycloak_admin_creds.stdout_lines[0] }}"
    keycloak_admin_password: "{{ keycloak_admin_creds.stdout_lines[1] }}"
    keycloak_url_effective: "{{ keycloak_url | default('http://' + ansible_default_ipv4.address + ':30180') }}"
    keycloak_realm_effective: "{{ keycloak_realm | default('cluster-services') }}"
    nextcloud_external_url_effective: "{{ nextcloud_external_url | default('http://' + hostvars['homelab']['ansible_host'] + ':30081') }}"
    nextcloud_external_host: "{{ (nextcloud_external_url | default('http://' + hostvars['homelab']['ansible_host'] + ':30081')) | regex_replace('^https?://', '') | regex_replace('/.*$', '') | regex_replace(':.*$', '') }}"
    nextcloud_external_hostport: "{{ (nextcloud_external_url | default('http://' + hostvars['homelab']['ansible_host'] + ':30081')) | regex_replace('^https?://', '') | regex_replace('/.*$', '') }}"
  no_log: true

- name: "Build Keycloak client definition for Nextcloud"
  ansible.builtin.set_fact:
    nextcloud_keycloak_clients_json: >-
      {{
        [
          {
            'name': 'nextcloud',
            'redirectUris': [
              nextcloud_external_url_effective + '/index.php/apps/oidc_login/oidc',
              nextcloud_external_url_effective + '/apps/oidc_login/oidc',
              nextcloud_external_url_effective + '/*'
            ],
            'baseUrl': nextcloud_external_url_effective + '/',
            'webOrigins': [ (nextcloud_external_url_effective | regex_replace('/$','')) ]
          }
        ] | to_json
      }}

- name: "Verify Keycloak client creation script exists"
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../../../cluster-infra/scripts/keycloak-create-clients.sh"
  register: keycloak_clients_script_stat

- name: "Fail if Keycloak client creation script is missing"
  ansible.builtin.fail:
    msg: "Missing script: {{ playbook_dir }}/../../../cluster-infra/scripts/keycloak-create-clients.sh (ensure cluster-infra repo is present at /opt/vmstation-org/cluster-infra)"
  when: not keycloak_clients_script_stat.stat.exists

- name: "Ensure Keycloak client creation script is executable"
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../../../cluster-infra/scripts/keycloak-create-clients.sh"
    mode: '0755'

- name: "Ensure Keycloak client for Nextcloud exists"
  ansible.builtin.command:
    argv:
      - bash
      - "{{ playbook_dir }}/../../../cluster-infra/scripts/keycloak-create-clients.sh"
      - --realm
      - "{{ keycloak_realm_effective }}"
      - --namespace
      - identity
      - --clients
      - "{{ nextcloud_keycloak_clients_json }}"
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
    KEYCLOAK_ADMIN_USER: "{{ keycloak_admin_user }}"
    KEYCLOAK_ADMIN_PASSWORD: "{{ keycloak_admin_password }}"
  register: keycloak_client_apply
  changed_when: false
  failed_when: false
  no_log: true

- name: "Capture Keycloak pod status (for diagnostics)"
  when: keycloak_client_apply.rc != 0
  ansible.builtin.command: kubectl -n identity get pods -l app.kubernetes.io/name=keycloak -o wide
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: keycloak_pods_diag
  changed_when: false
  failed_when: false

- name: "Capture Keycloak logs tail (for diagnostics)"
  when: keycloak_client_apply.rc != 0
  ansible.builtin.command: kubectl -n identity logs -l app.kubernetes.io/name=keycloak --tail=200
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: keycloak_logs_diag
  changed_when: false
  failed_when: false

- name: "Fail with actionable diagnostics if Keycloak client creation failed"
  when: keycloak_client_apply.rc != 0
  ansible.builtin.fail:
    msg: |
      Keycloak client creation for Nextcloud failed (exit code {{ keycloak_client_apply.rc }}).
      
      Keycloak pods:
      {{ (keycloak_pods_diag.stdout | default('(no output)')) }}
      
      Keycloak logs (tail):
      {{ (keycloak_logs_diag.stdout | default('(no output)')) }}

- name: "Read Nextcloud client secret from identity namespace"
  ansible.builtin.shell: |
    set -euo pipefail
    kubectl -n identity get secret keycloak-nextcloud-client-secret -o jsonpath='{.data.client_secret}' | base64 -d
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: nextcloud_client_secret
  changed_when: false
  no_log: true

- name: "Check if nextcloud-secrets already exists"
  ansible.builtin.command: kubectl -n nextcloud get secret nextcloud-secrets
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: nextcloud_secrets_get
  changed_when: false
  failed_when: false

- name: "Set nextcloud secret exists flag"
  ansible.builtin.set_fact:
    nextcloud_secrets_exists: "{{ nextcloud_secrets_get.rc == 0 }}"

- name: "Create nextcloud-secrets manifest (temp file)"
  when: not nextcloud_secrets_exists
  ansible.builtin.copy:
    dest: /tmp/nextcloud-secrets.yaml
    mode: '0600'
    content: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: nextcloud-secrets
        namespace: nextcloud
      type: Opaque
      stringData:
        db-name: "{{ nextcloud_db_name | default('nextcloud') }}"
        db-user: "{{ nextcloud_db_user | default('nextcloud') }}"
        db-password: "{{ nextcloud_db_password | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits')) }}"
        mariadb-root-password: "{{ nextcloud_mariadb_root_password | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits')) }}"
        admin-user: "{{ nextcloud_admin_user | default('admin') }}"
        admin-password: "{{ nextcloud_admin_password | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits')) }}"
        oidc-provider-url: "{{ keycloak_url_effective }}/auth/realms/{{ keycloak_realm_effective }}"
        oidc-client-id: "nextcloud"
        oidc-client-secret: "{{ nextcloud_client_secret.stdout }}"
        oidc-logout-url: "{{ keycloak_url_effective }}/auth/realms/{{ keycloak_realm_effective }}/protocol/openid-connect/logout"
        trusted-domains: "{{ nextcloud_external_host }}"
        overwritehost: "{{ nextcloud_external_hostport }}"
        overwriteprotocol: "{{ (nextcloud_external_url_effective | regex_search('^https?')) | default('http') }}"
        overwritecliurl: "{{ nextcloud_external_url_effective }}"
  no_log: true

- name: "Apply nextcloud-secrets once (do not rotate on reruns)"
  when: not nextcloud_secrets_exists
  ansible.builtin.command: kubectl apply -f /tmp/nextcloud-secrets.yaml
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: nextcloud_secrets_apply
  changed_when: "'created' in nextcloud_secrets_apply.stdout or 'configured' in nextcloud_secrets_apply.stdout"
  no_log: true

- name: "Remove temp nextcloud-secrets manifest"
  when: not nextcloud_secrets_exists
  ansible.builtin.file:
    path: /tmp/nextcloud-secrets.yaml
    state: absent
  changed_when: false
